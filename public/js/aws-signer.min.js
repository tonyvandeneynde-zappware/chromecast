
function byteLength(str) {
  var s = str.length;
  for (var i = str.length-1; i >= 0; i--) {
    var code = str.charCodeAt(i);
    if (code > 0x7f && code <= 0x7ff) s++;
    else if (code > 0x7ff && code <= 0xffff) s += 2;
    if (code >= 0xDC00 && code <= 0xDFFF) i--;
  }
  return s;
}

function urlParse(url) {
    var match = url.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)([\/]{0,1}[^?#]*)(\?[^#]*|)(#.*|)$/);
    return match && {
        href: url,
        protocol: match[1],
        host: match[2],
        hostname: match[3],
        port: match[4],
        pathname: match[5],
        search: match[6],
        hash: match[7]
    };
}

// https://stackoverflow.com/questions/2090551/parse-query-string-in-javascript
function parseQuery(str) {
    if (typeof str !== "string" || str.length === 0)
        return {};
    var s = str.split("&");
    var bit, query = {}, first, second;
    for (var i = 0; i < s.length; i++) {
        bit = s[i].split("=");
        first = decodeURIComponent(bit[0]);
        if (first.length === 0)
            continue;
        second = decodeURIComponent(bit[1]);
        if (typeof query[first] === "undefined")
            query[first] = second;
        else if (query[first] instanceof Array)
            query[first].push(second);
        else
            query[first] = [query[first], second];
    }
    return query;
}

// https://stackoverflow.com/questions/1714786/query-string-encoding-of-a-javascript-object
function serialize(obj) {
    var str = [];
    for (var p in obj)
        if (obj.hasOwnProperty(p)) {
            if (obj[p] instanceof Array) {
                for (var q in obj[p]) {
                    str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p][q]));
                }
            } else {
                str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
            }
        }
    return str.join("&");
}


/* Lru File */
// source: https://github.com/mhart/aws4/blob/master/lru.js
function LruCache(e){this.capacity=0|e,this.map=Object.create(null),this.list=new DoublyLinkedList}function DoublyLinkedList(){this.firstNode=null,this.lastNode=null}function DoublyLinkedNode(e,t){this.key=e,this.val=t,this.prev=null,this.next=null}LruCache.prototype.get=function(e){var t=this.map[e];if(null!=t)return this.used(t),t.val},LruCache.prototype.set=function(e,t){var s=this.map[e];if(null!=s)s.val=t;else{if(this.capacity||this.prune(),!this.capacity)return!1;s=new DoublyLinkedNode(e,t),this.map[e]=s,this.capacity--}return this.used(s),!0},LruCache.prototype.used=function(e){this.list.moveToFront(e)},LruCache.prototype.prune=function(){var e=this.list.pop();null!=e&&(delete this.map[e.key],this.capacity++)},DoublyLinkedList.prototype.moveToFront=function(e){this.firstNode!=e&&(this.remove(e),null==this.firstNode?(this.firstNode=e,(this.lastNode=e).prev=null,e.next=null):(e.prev=null,e.next=this.firstNode,e.next.prev=e,this.firstNode=e))},DoublyLinkedList.prototype.pop=function(){var e=this.lastNode;return null!=e&&this.remove(e),e},DoublyLinkedList.prototype.remove=function(e){this.firstNode==e?this.firstNode=e.next:null!=e.prev&&(e.prev.next=e.next),this.lastNode==e?this.lastNode=e.prev:null!=e.next&&(e.next.prev=e.prev)};var aws4={},credentialsCache=new LruCache(1e3);function hmac(e,t,s){var i=CryptoJS.algo.HMAC.create(CryptoJS.algo.SHA256,e).update(t).finalize();return"hex"===s?i.toString(CryptoJS.enc.Hex):"base64"===s?i.toString(CryptoJS.enc.Base64):"utf8"===s?i.toString(CryptoJS.enc.Utf8):i}function hash(e,t){var s=CryptoJS.algo.SHA256.create();s.update(e);var i=s.finalize();return"hex"===t?i.toString(CryptoJS.enc.Hex):"base64"===t?i.toString(CryptoJS.enc.Base64):"utf8"===t?i.toString(CryptoJS.enc.Utf8):i}function encodeRfc3986(e){return e.replace(/[!'()*]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})}function RequestSigner(e,t){"string"==typeof e&&(e=urlParse(e));var s=e.headers=e.headers||{},i=this.matchHost(e.hostname||e.host||s.Host||s.host);this.request=e,this.credentials=t||this.defaultCredentials(),this.service=e.service||i[0]||"",this.region=e.region||i[1]||"us-east-1","email"===this.service&&(this.service="ses"),!e.method&&e.body&&(e.method="POST"),s.Host||s.host||(s.Host=e.hostname||e.host||this.createHost(),e.port&&(s.Host+=":"+e.port)),e.hostname||e.host||(e.hostname=s.Host||s.host),this.isCodeCommitGit="codecommit"===this.service&&"GIT"===e.method}RequestSigner.prototype.matchHost=function(e){var t=((e||"").match(/([^\.]+)\.(?:([^\.]*)\.)?amazonaws\.com$/)||[]).slice(1,3);return"es"===t[1]&&(t=t.reverse()),t},RequestSigner.prototype.isSingleRegion=function(){return 0<=["s3","sdb"].indexOf(this.service)&&"us-east-1"===this.region||0<=["cloudfront","ls","route53","iam","importexport","sts"].indexOf(this.service)},RequestSigner.prototype.createHost=function(){var e=this.isSingleRegion()?"":("s3"===this.service&&"us-east-1"!==this.region?"-":".")+this.region;return("ses"===this.service?"email":this.service)+e+".amazonaws.com"},RequestSigner.prototype.prepareRequest=function(){this.parsePath();var e,t=this.request,s=t.headers;t.signQuery?(this.parsedPath.query=e=this.parsedPath.query||{},this.credentials.sessionToken&&(e["X-Amz-Security-Token"]=this.credentials.sessionToken),"s3"!==this.service||e["X-Amz-Expires"]||(e["X-Amz-Expires"]=86400),e["X-Amz-Date"]?this.datetime=e["X-Amz-Date"]:e["X-Amz-Date"]=this.getDateTime(),e["X-Amz-Algorithm"]="AWS4-HMAC-SHA256",e["X-Amz-Credential"]=this.credentials.accessKeyId+"/"+this.credentialString(),e["X-Amz-SignedHeaders"]=this.signedHeaders()):(t.doNotModifyHeaders||this.isCodeCommitGit||(!t.body||s["Content-Type"]||s["content-type"]||(s["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8"),!t.body||s["Content-Length"]||s["content-length"]||(s["Content-Length"]=byteLength(t.body)),!this.credentials.sessionToken||s["X-Amz-Security-Token"]||s["x-amz-security-token"]||(s["X-Amz-Security-Token"]=this.credentials.sessionToken),"s3"!==this.service||s["X-Amz-Content-Sha256"]||s["x-amz-content-sha256"]||(s["X-Amz-Content-Sha256"]=hash(this.request.body||"","hex")),s["X-Amz-Date"]||s["x-amz-date"]?this.datetime=s["X-Amz-Date"]||s["x-amz-date"]:s["X-Amz-Date"]=this.getDateTime()),delete s.Authorization,delete s.authorization)},RequestSigner.prototype.sign=function(){return this.parsedPath||this.prepareRequest(),this.request.signQuery?this.parsedPath.query["X-Amz-Signature"]=this.signature():this.request.headers.Authorization=this.authHeader(),this.request.path=this.formatPath(),this.request},RequestSigner.prototype.getDateTime=function(){if(!this.datetime){var e=this.request.headers,t=new Date(e.Date||e.date||new Date);this.datetime=t.toISOString().replace(/[:\-]|\.\d{3}/g,""),this.isCodeCommitGit&&(this.datetime=this.datetime.slice(0,-1))}return this.datetime},RequestSigner.prototype.getDate=function(){return this.getDateTime().substr(0,8)},RequestSigner.prototype.authHeader=function(){return["AWS4-HMAC-SHA256 Credential="+this.credentials.accessKeyId+"/"+this.credentialString(),"SignedHeaders="+this.signedHeaders(),"Signature="+this.signature()].join(", ")},RequestSigner.prototype.signature=function(){var e=this.getDate(),t=[this.credentials.secretAccessKey,e,this.region,this.service].join(),s=credentialsCache.get(t);return s||(s=hmac(hmac(hmac(hmac("AWS4"+this.credentials.secretAccessKey,e),this.region),this.service),"aws4_request"),credentialsCache.set(t,s)),hmac(s,this.stringToSign(),"hex")},RequestSigner.prototype.stringToSign=function(){return["AWS4-HMAC-SHA256",this.getDateTime(),this.credentialString(),hash(this.canonicalString(),"hex")].join("\n")},RequestSigner.prototype.canonicalString=function(){this.parsedPath||this.prepareRequest();var e,t=this.parsedPath.path,s=this.parsedPath.query,i=this.request.headers,r="",n="s3"!==this.service,o="s3"===this.service||this.request.doNotEncodePath,a="s3"===this.service,h="s3"===this.service;return e="s3"===this.service&&this.request.signQuery?"UNSIGNED-PAYLOAD":this.isCodeCommitGit?"":i["X-Amz-Content-Sha256"]||i["x-amz-content-sha256"]||hash(this.request.body||"","hex"),s&&(r=encodeRfc3986(serialize(Object.keys(s).sort().reduce(function(e,t){return t&&(e[t]=Array.isArray(s[t])?h?s[t][0]:s[t].slice().sort():s[t]),e},{})))),"/"!==t&&(n&&(t=t.replace(/\/{2,}/g,"/")),"/"!==(t=t.split("/").reduce(function(e,t){return n&&".."===t?e.pop():n&&"."===t||(o&&(t=decodeURIComponent(t)),e.push(encodeRfc3986(encodeURIComponent(t)))),e},[]).join("/"))[0]&&(t="/"+t),a&&(t=t.replace(/%2F/g,"/"))),[this.request.method||"GET",t,r,this.canonicalHeaders()+"\n",this.signedHeaders(),e].join("\n")},RequestSigner.prototype.canonicalHeaders=function(){var t=this.request.headers;return Object.keys(t).sort(function(e,t){return e.toLowerCase()<t.toLowerCase()?-1:1}).map(function(e){return e.toLowerCase()+":"+function(e){return e.toString().trim().replace(/\s+/g," ")}(t[e])}).join("\n")},RequestSigner.prototype.signedHeaders=function(){return Object.keys(this.request.headers).map(function(e){return e.toLowerCase()}).sort().join(";")},RequestSigner.prototype.credentialString=function(){return[this.getDate(),this.region,this.service,"aws4_request"].join("/")},RequestSigner.prototype.defaultCredentials=function(){var e=process.env;return{accessKeyId:e.AWS_ACCESS_KEY_ID||e.AWS_ACCESS_KEY,secretAccessKey:e.AWS_SECRET_ACCESS_KEY||e.AWS_SECRET_KEY,sessionToken:e.AWS_SESSION_TOKEN}},RequestSigner.prototype.parsePath=function(){var e=this.request.path||"/",t=e.indexOf("?"),s=null;0<=t&&(s=parseQuery(e.slice(t+1)),e=e.slice(0,t)),/[^0-9A-Za-z!'()*\-._~%/]/.test(e)&&(e=e.split("/").map(function(e){return encodeURIComponent(decodeURIComponent(e))}).join("/")),this.parsedPath={path:e,query:s}},RequestSigner.prototype.formatPath=function(){var e=this.parsedPath.path,t=this.parsedPath.query;return t?(null!=t[""]&&delete t[""],e+"?"+encodeRfc3986(serialize(t))):e};